# comments_summary

Проект по саммаризации и извлечению ключевых слов из отзывов покупателей на товары.

##TODO
- __придумать для чего могут быть нужны очереди (модель не обучаем)__
- придумать склейку стримлита и nginx
- арендовать сервак с GPU
- добавить ноутбуки с генерацией разметки и дообучением llm (может и с рисечем)
- добавить ручку по извлечению атрибутов и их характеристик 


## структура проекта

### app/
-  **main.py**: FastAPI-приложения; здесь создаётся экземпляр приложения и подключаются роутеры
- **api.py**: определение API-эндпоинтов для суммаризации отзывов, извлечения ключевых слов и запуска асинхронного инференса
- **models.py**: функции-обёртки для вызова моделей (суммаризация, извлечение ключевых слов)
- **tasks.py**: определение задач для Celery (асинхронный инференс и обновление статусов в БД??? TODO: подумать как следует)
- **database.py**: подключение и работа с PostgreSQL (логирование обращений, обновление статусов задач)
- **config.py**: конфиг проекта (настройки, переменные окружения, параметры подключения к БД и брокеру сообщений). локально храним в .env, потом надо сделать yaml файлы (TODO: ci/cd кажется удобней в гитлабе, чем в гитхабе, возможно перееду)

### streamlit_app/
- **app.py**: Визуальное представление результатов обработки отзывов с использованием Streamlit.

### static/  Статические файлы (CSS?? изображения?? TODO: продумать что именно)
- css/
- images/

### nginx/
 - **nginx.conf**         # конфиг nginx для reverse proxy, маршрутизации запросов к API и отдавания статики

###  docker/
- **dockerfile.app**: докер для сборки образа FastAPI-приложения (uvicorn).
- **dockerfile.celery**: докер для сборки образа Celery-воркера для асинхронного выполнения задач.
- **dockerfile.streamlit**: докер для сборки образа Streamlit визуала.
- **dockerfile.static**: докер для сборки образа для сервиса отдачи статики (на базе nginx??).

### research/
неупорядоченные юпитер тетрадки

- **docker-compose.yml**: определение всех необходимых сервисов (API, Celery, Streamlit, PostgreSQL, RabbitMQ/Redis???, Nginx) для развёртывания проекта.
- **requirements.txt**: пакеты python (FastAPI, uvicorn, celery, SQLAlchemy, psycopg2, и т.п.)
- **README.md**: описание проекта, инструкция по запуску и настройке

## Установка

1. Клонировать репозиторий:
   ```bash
   git clone git@github.com:DariaMishina/comments_summary.git
   cd comments_summary
   ```

2. для запуска в docker
- создаем docker образ
    ```bash
    docker build -t comments_summary_app:latest -f docker/Dockerfile.app .
    ```
- запускаем docker контейнер (порт 8000 для мэппинга выбран произвольно)
    ```bash
    docker run -p 8000:8000 comments_summary_app:latest
    ```

3. __docker compose__

   Добавила БД для хранения логов вызова микросервиса, теперь нужен docker compose
- собраем образ перед запуском
    ```bash
    docker compose build
    ```
- запускаем все вместе в фоновом режиме (-d):
    ```bash
    docker compose up -d
    ```
- SQLAlchemy создает таблицы:
    ```bash
    docker exec -it my_app python -c "from app.database import Base, engine; Base.metadata.create_all(engine)"
    ```
- проверяем появилась ли таблица в PostgreSQL:
    ```bash
    docker exec -it postgres_db psql -U user -d mydatabase -c "SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname = 'public';"
    ```
- дальше стучимся в сервис (см curl`ы ниже) и проверяем появляются ли записи в таблице 
    ```bash
    docker exec -it postgres_db psql -U user -d mydatabase -c "SELECT * FROM request_logs LIMIT 10;"
    ```
- если что-то пошло не так, что можно удалить БД и запустить заново (-v удалит все данные в БД! но на этапе теста там того и надо) 
  ```bash
    docker-compose down -v
    ```


- curl для проверки эндпоинтов

1) самая простецка ручка - просто для проверки сервиса
    ```bash
    curl -X GET "http://127.0.0.1:8000/ping"
    ```
2) для ключевых слов
    ```bash
    curl -X POST "http://127.0.0.1:8000/keywords" \
     -H "Content-Type: application/json" \
     -d '{
           "text": "Купил арбуз, он был спелым, сочным и с приятной сладостью, что приятно удивило.\nАрбуз оказался неравномерно спелым: одна половина слишком твердая, другая — мягкая, но вкус всё равно хороший.\nПри покупке для пикника выбрал арбуз, который порадовал насыщенным ароматом и отличной текстурой мякоти.\nНе впечатлил арбуз: мякоть оказалась водянистой, а сладость была недостаточной, несмотря на красивую кожуру.\nОтличный арбуз: насыщенный цвет, идеальный баланс сладости и лёгкой кислинки – настоящий летний десерт."
         }'
    ```
3) для саммари - если нет GPU, будет сюрприз 
    ```bash
    curl -X POST "http://127.0.0.1:8000/summarize" \
     -H "Content-Type: application/json" \
     -d '{
           "text": "Купил арбуз, он был спелым, сочным и с приятной сладостью, что приятно удивило.\nАрбуз оказался неравномерно спелым: одна половина слишком твердая, другая — мягкая, но вкус всё равно хороший.\nПри покупке для пикника выбрал арбуз, который порадовал насыщенным ароматом и отличной текстурой мякоти.\nНе впечатлил арбуз: мякоть оказалась водянистой, а сладость была недостаточной, несмотря на красивую кожуру.\nОтличный арбуз: насыщенный цвет, идеальный баланс сладости и лёгкой кислинки – настоящий летний десерт."
         }'
    ```
