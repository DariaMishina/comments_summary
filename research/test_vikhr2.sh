#!/bin/bash

API_URL="http://localhost:8080/v1/chat/completions"
MODEL="Vikhr-7B-instruct_0.4_lora_r32_medium_prompt"
OUTPUT_DIR="./test_results2"
REVIEWS_DIR="./reviews"

mkdir -p $OUTPUT_DIR

# Parameter ranges
TEMPERATURES=(0.05 0.1 0.2 0.3)
TOP_PS=(0.8 0.85 0.9 0.95)
REPETITION_PENALTIES=(1.1 1.2 1.3 1.4 1.5)
MAX_TOKENS_LIST=(200 300 400)

# Loop over each review file
for REVIEW_FILE in "$REVIEWS_DIR"/*.txt; do
  REVIEWS=$(cat "$REVIEW_FILE")
  REVIEW_NAME=$(basename "$REVIEW_FILE" .txt)

  for MAX_TOKENS in "${MAX_TOKENS_LIST[@]}"; do
    for TEMP in "${TEMPERATURES[@]}"; do
      for TOP in "${TOP_PS[@]}"; do
        for PENALTY in "${REPETITION_PENALTIES[@]}"; do

        echo "Running tests for $REVIEW_NAME with: temperature=$TEMP | top_p=$TOP | repetition_penalty=$PENALTY"
        timestamp=$(date +"%Y%m%d_%H%M%S")
        PARAM_LABEL="${REVIEW_NAME}_tokens${MAX_TOKENS}_temp${TEMP}_top${TOP}_pen${PENALTY}_$timestamp"

        COMMON_PARAMS="\"max_tokens\": $MAX_TOKENS, \"temperature\": $TEMP, \"top_p\": $TOP, \"repetition_penalty\": $PENALTY"


        ### --------- TEST 1: Краткий список ---------
        curl -s $API_URL \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer EMPTY" \
        -d "{
          \"model\": \"$MODEL\",
          $COMMON_PARAMS,
          \"stop\": [\"\\n\\n\"],
          \"messages\": [
            {
              \"role\": \"system\",
              \"content\": \"Ты получишь тексты отзывов покупателей об одном продукте. Выдели только конкретные атрибуты товара, про которые пишут покупатели. Возможные варианты атрибутов: вкус, цвет, консистенция, запах. Формат ответа: список атрибутов без лишнего текста, комментариев и обобщений. Каждый атрибут на новой строке. Повторы запрещены. Пример: вкус: сладкий\\nцвет: красный\\nконсистенция: мягкая\\nзапах: ароматный\"
            },
            {
              \"role\": \"user\",
              \"content\": \"$REVIEWS\"
            }
          ]
        }" | tee "$OUTPUT_DIR/test1_${PARAM_LABEL}.json" | jq .

        ### --------- TEST 2: JSON формат ---------
        curl -s $API_URL \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer EMPTY" \
        -d "{
          \"model\": \"$MODEL\",
          $COMMON_PARAMS,
          \"stop\": [\"}\"],
          \"messages\": [
            {
              \"role\": \"system\",
              \"content\": \"Ты анализируешь отзывы на товары. Извлеки атрибуты товара (вкус, цвет, консистенция, запах), упомянутые в отзыве. Результат строго в формате JSON. Пример:\\n{\\\"атрибуты\\\": {\\\"вкус\\\": [\\\"сладкий\\\", \\\"кислый\\\"], \\\"цвет\\\": [\\\"красный\\\"], \\\"консистенция\\\": [\\\"мягкая\\\"], \\\"запах\\\": [\\\"ароматный\\\"]}}\\nНикаких комментариев и пояснений, только JSON.\"
            },
            {
              \"role\": \"user\",
              \"content\": \"$REVIEWS\"
            }
          ]
        }" | tee "$OUTPUT_DIR/test2_${PARAM_LABEL}.json" | jq .

        ### --------- TEST 3: Few-shot ---------
        curl -s $API_URL \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer EMPTY" \
        -d "{
          \"model\": \"$MODEL\",
          $COMMON_PARAMS,
          \"stop\": [\"\\n\\n\"],
          \"messages\": [
            {
              \"role\": \"system\",
              \"content\": \"Ты помощник, который анализирует отзывы на товары и выделяет атрибуты. Ниже представлен список отзывов на мандарины:\\nОчень вкусные, сладкие! Никакие абхазские не нужны))\\nОгромные, почти безвкусные\\nХорошие мандарины, в меру сладкие, без косточек\\nсладкие, косточек не попалось, кожура тонкая и легко чистится\\nиз этого списка отзывов выделяем атрибуты:\\nвкус: сладкий, безвкусный\\nразмер: огромный\\nструктура: без косточек\\nкожура: тонкая и легко чистится\\n\\nТеперь проанализируй отзыв про яблоки и выдели атрибуты аналогично.\"
            },
            {
              \"role\": \"user\",
              \"content\": \"$REVIEWS\"
            }
          ]
        }" | tee "$OUTPUT_DIR/test3_${PARAM_LABEL}.json" | jq .

        ### --------- TEST 4: Новый длинный пример (мандарины + объяснения) ---------
        curl -s $API_URL \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer EMPTY" \
        -d "{
          \"model\": \"$MODEL\",
          $COMMON_PARAMS,
          \"stop\": [\"\\n\\n\"],
          \"messages\": [
            {
              \"role\": \"system\",
              \"content\": \"Ты помощник, который анализирует отзывы на товары. Ты получишь тексты отзывов покупателей об одном продукте. Выдели атрибуты товара (например, вкус, запах, текстура, цвет), про которые пишут покупатели. У одного атрибута может быть много характеристик. Атрибут выражается 1-3 словами всегда, кратко и емко. Чаще всего покупатели описывают характеристики атрибутов (например, сладкий, свежий, мягкий, сочный), а тебе нужно выделить именно сами атрибуты. Ниже представлен список отзывов на мандарины, каждый новый отзыв с новой строки:\\nОчень вкусные, сладкие! Никакие абхазские не нужны))\\nОгромные, почти безвкусные\\nХорошие мандарины, в меру сладкие, без косточек\\nНам понравились! Очень свежие, прямо  на веточках и с листиками. Тонкая шкурка, чистится легко. На вкус разные. Зависит от спелости мандарина. Попадаются и кисленькие, и сладкие, и кисло-сладкие, но все сочные и нежные. Спасибо доставке по городу Одинцово!\\nВкусные свежие\\nМандарины без косточек, легко чистятся, в основном сладкие. По кислости попадаются разные, лично мне нравятся те, что покислее. Даже в одном мандарине иногда часть долек кислее других - странно. Иногда попадаются подсушенные мандарины, как будто их переморозили, но в основном мандарины хорошие.\\nНеплохие, но немного кисловаты.\\nсладкие, косточек не попалось, кожура тонкая и легко чистится\\nСпасибо, тонкокорые,сочные ,сладкие,очень понравились\\nМандарины очень сладкие. Вкусные\\nЛюбимые мандарины\\nБезвкусные. Иран\\nиз этого списка отзывов выделяем следующие атрибуты и их характеристики:\\nвкус: сладкий, безвкусный\\nразмер: огромный\\nкожура: тонкая и легко чистится\\nструктура: без косточек, легко чистятся\\nтекстура: сочные, подсушенные\\nНапример, если пишут, что продукт кислый, сладкий, горький, это атрибут вкус, если пишут что продукт с комочками, волокнистый, то это атрибут консистенция. Если в отзыве упомянуто несколько атрибутов, извлекай их все. Возвращай результат в формате: список атрибутов и их описаний.\"
            },
            {
              \"role\": \"user\",
              \"content\": \"$REVIEWS\"
            }
          ]
        }" | tee "$OUTPUT_DIR/test4_${PARAM_LABEL}.json" | jq .

        ### --------- TEST 5: Сжатый вариант без примеров ---------
        curl -s $API_URL \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer EMPTY" \
        -d "{
          \"model\": \"$MODEL\",
          $COMMON_PARAMS,
          \"stop\": [\"\\n\\n\"],
          \"messages\": [
            {
              \"role\": \"system\",
              \"content\": \"Ты помощник, который анализирует отзывы на товары. Ты получишь тексты отзывов покупателей об одном продукте. Выдели атрибуты товара (например, вкус, запах, текстура, цвет), про которые пишут покупатели. У одного атрибута может быть много характеристик. Атрибут выражается 1-3 словами всегда, кратко и емко. Чаще всего покупатели описывают характеристики атрибутов (например, сладкий, свежий, мягкий, сочный), а тебе нужно выделить именно сами атрибуты. Например, если пишут, что продукт кислый, сладкий, горький, это атрибут вкус, если пишут что продукт с комочками, волокнистый, то это атрибут консистенция. Если в отзыве упомянуто несколько атрибутов, извлекай их все. Возвращай результат в формате: список атрибутов и их описаний.\"
            },
            {
              \"role\": \"user\",
              \"content\": \"$REVIEWS\"
            }
          ]
        }" | tee "$OUTPUT_DIR/test5_${PARAM_LABEL}.json" | jq .

        echo "Completed tests for $REVIEW_NAME | temperature=$TEMP, top_p=$TOP, penalty=$PENALTY"
        echo "------------------------------------------"
        done
      done
    done
  done
done

echo "All parameter combinations and review files tested. Results in $OUTPUT_DIR"