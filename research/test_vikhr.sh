#!/bin/bash

API_URL="http://localhost:8080/v1/chat/completions"
MODEL="Vikhr-7B-instruct_0.4_lora_r32_medium_prompt"
OUTPUT_DIR="./test_results"
mkdir -p $OUTPUT_DIR

REVIEWS="Огромные и не очень вкусные Замечательные!! Мне очень понравились яблоки этого сорта. Сочные, сладкие! Вата, а не яблоки Сочные, вкусные Привезли очень крупные яблоки! На вкус ароматные и сладкие. Для тех кто любит мягкие. Сочные сладкие крепкие Яблоки просто восторг!- не ожидала! Сочные, ароматные, не жесткие- даже кожа хорошо жуётся! Сладкие. Брала со скидкой. Закажу ещё на завтра. Не уверена что привезут такие же- иначе бы кг 3 заказала. Привезли в заказе ужасные яблоки!!Есть такие невозможно (( Небольшие сочные хрустящие яблочки, блеск Крупненькие оказались, ожидала мелкие яблочки. Красивее, чем на фото.) Мне для пирога. Спасибо. Впервые в продаже такие красивые сезонные яблоки. И вкусные. Яблоки вкусные, но очень большие. Хотелось бы поменьше размером. Крупные. Мало косточек. Кисло сладкие. Мякоть мягкая и сочная. Кожица не толстая. Очень вкусные! Ужасные яблоки, кожура потемневшая, внутри ватные Очень вкусные и сладкие яблоки. Сочные. Приятные яблочки. Сочные, в меру сладкие. Кожица несколько плотновата. Хорошие крупные яблоки. Вкусные. Очень ароматные и сладкие! Те, что темно-красные даже очень сладкие! Хорошие мелкие сезонные яблоки. Адекватная цена. Вкусные яблоки, душистые"

# Parameter ranges
TEMPERATURES=(0.1 0.2 0.3)
TOP_PS=(0.9 0.95)
REPETITION_PENALTIES=(1.1 1.2 1.3)
MAX_TOKENS=400

# Iterate over combinations
for TEMP in "${TEMPERATURES[@]}"; do
  for TOP in "${TOP_PS[@]}"; do
    for PENALTY in "${REPETITION_PENALTIES[@]}"; do

      echo "Running tests with: temperature=$TEMP | top_p=$TOP | repetition_penalty=$PENALTY"
      timestamp=$(date +"%Y%m%d_%H%M%S")
      PARAM_LABEL="temp${TEMP}_top${TOP}_pen${PENALTY}_$timestamp"

      COMMON_PARAMS="\"max_tokens\": $MAX_TOKENS, \"temperature\": $TEMP, \"top_p\": $TOP, \"repetition_penalty\": $PENALTY"

      ### --------- TEST 1: Краткий список ---------
      echo "Test 1..."
      curl -s $API_URL \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer EMPTY" \
      -d "{
        \"model\": \"$MODEL\",
        $COMMON_PARAMS,
        \"stop\": [\"\\n\\n\"],
        \"messages\": [
          {
            \"role\": \"system\",
            \"content\": \"Ты получишь тексты отзывов покупателей об одном продукте. Выдели только конкретные атрибуты товара, про которые пишут покупатели. Возможные варианты атрибутов: вкус, цвет, консистенция, запах. Формат ответа: список атрибутов без лишнего текста, комментариев и обобщений. Каждый атрибут на новой строке. Повторы запрещены. Пример: вкус: сладкий\\nцвет: красный\\nконсистенция: мягкая\\nзапах: ароматный\"
          },
          {
            \"role\": \"user\",
            \"content\": \"$REVIEWS\"
          }
        ]
      }" | tee "$OUTPUT_DIR/test1_${PARAM_LABEL}.json" | jq .

      ### --------- TEST 2: JSON формат ---------
      echo "Test 2..."
      curl -s $API_URL \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer EMPTY" \
      -d "{
        \"model\": \"$MODEL\",
        $COMMON_PARAMS,
        \"stop\": [\"}\"],
        \"messages\": [
          {
            \"role\": \"system\",
            \"content\": \"Ты анализируешь отзывы на товары. Извлеки атрибуты товара (вкус, цвет, консистенция, запах), упомянутые в отзыве. Результат строго в формате JSON. Пример:\\n{\\\"атрибуты\\\": {\\\"вкус\\\": [\\\"сладкий\\\", \\\"кислый\\\"], \\\"цвет\\\": [\\\"красный\\\"], \\\"консистенция\\\": [\\\"мягкая\\\"], \\\"запах\\\": [\\\"ароматный\\\"]}}\\nНикаких комментариев и пояснений, только JSON.\"
          },
          {
            \"role\": \"user\",
            \"content\": \"$REVIEWS\"
          }
        ]
      }" | tee "$OUTPUT_DIR/test2_${PARAM_LABEL}.json" | jq .

      ### --------- TEST 3: Few-shot ---------
      echo "Test 3..."
      curl -s $API_URL \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer EMPTY" \
      -d "{
        \"model\": \"$MODEL\",
        $COMMON_PARAMS,
        \"stop\": [\"\\n\\n\"],
        \"messages\": [
          {
            \"role\": \"system\",
            \"content\": \"Ты помощник, который анализирует отзывы на товары и выделяет атрибуты. Ниже представлен список отзывов на мандарины:\\nОчень вкусные, сладкие! Никакие абхазские не нужны))\\nОгромные, почти безвкусные\\nХорошие мандарины, в меру сладкие, без косточек\\nсладкие, косточек не попалось, кожура тонкая и легко чистится\\nиз этого списка отзывов выделяем атрибуты:\\nвкус: сладкий, безвкусный\\nразмер: огромный\\nструктура: без косточек\\nкожура: тонкая и легко чистится\\n\\nТеперь проанализируй отзыв про яблоки и выдели атрибуты аналогично.\"
          },
          {
            \"role\": \"user\",
            \"content\": \"$REVIEWS\"
          }
        ]
      }" | tee "$OUTPUT_DIR/test3_${PARAM_LABEL}.json" | jq .

      echo "Completed tests for temperature=$TEMP, top_p=$TOP, penalty=$PENALTY"
      echo "------------------------------------------"

    done
  done
done

echo "All parameter combinations tested. Results in $OUTPUT_DIR"